# =============================================================================
# RAG Knowledge Base SAAS Platform - Docker Compose Configuration
# Version 1.0.0 - Simplified Monolith Architecture
# =============================================================================
#
# This is the default configuration for running the platform as a monolith.
# For microservices architecture, see docker-compose.microservices.yml
#
# Quick Start:
#   1. Copy .env.example to .env and configure your API keys
#   2. Run: docker-compose up --build
#   3. Access: http://localhost:3000
#
# =============================================================================

services:
  # =============================================================================
  # DATABASE - PostgreSQL with pgvector extension
  # =============================================================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: digitaltwin-db
    environment:
      POSTGRES_DB: digitaltwin
      POSTGRES_USER: digitaltwin_user
      POSTGRES_PASSWORD: digitaltwin_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/initdb:/docker-entrypoint-initdb.d
    networks:
      - digitaltwin-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U digitaltwin_user -d digitaltwin" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # =============================================================================
  # REDIS - Job queue for web scraping
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: digitaltwin-redis
    ports:
      - "6379:6379"
    networks:
      - digitaltwin-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3

  # =============================================================================
  # BACKEND - Express API (Monolith)
  # =============================================================================
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: digitaltwin-backend
    environment:
      # Server
      NODE_ENV: development
      PORT: 3001
      LOG_LEVEL: debug
      CORS_ORIGIN: http://localhost:3000

      # Database
      DATABASE_URL: postgresql://digitaltwin_user:digitaltwin_pass@postgres:5432/digitaltwin

      # Security
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-your-encryption-key-change-in-production}

      # LLM Providers (at least one required)
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}

      # Frontend
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      REACT_APP_URL: ${REACT_APP_URL:-http://localhost:3000}

      # OAuth - User Login
      GOOGLE_OAUTH_CLIENT_ID: ${GOOGLE_OAUTH_CLIENT_ID}
      GOOGLE_OAUTH_CLIENT_SECRET: ${GOOGLE_OAUTH_CLIENT_SECRET}
      GOOGLE_OAUTH_REDIRECT_URI: ${GOOGLE_OAUTH_REDIRECT_URI:-http://localhost:3001/api/oauth/auth/google/callback}
      GITHUB_OAUTH_CLIENT_ID: ${GITHUB_OAUTH_CLIENT_ID}
      GITHUB_OAUTH_CLIENT_SECRET: ${GITHUB_OAUTH_CLIENT_SECRET}
      GITHUB_OAUTH_REDIRECT_URI: ${GITHUB_OAUTH_REDIRECT_URI:-http://localhost:3001/api/oauth/auth/github/callback}

      # OAuth - Email Integration
      GMAIL_CLIENT_ID: ${GMAIL_CLIENT_ID}
      GMAIL_CLIENT_SECRET: ${GMAIL_CLIENT_SECRET}
      GMAIL_REDIRECT_URI: ${GMAIL_REDIRECT_URI:-http://localhost:3001/api/email/auth/gmail/callback}
      OUTLOOK_CLIENT_ID: ${OUTLOOK_CLIENT_ID}
      OUTLOOK_CLIENT_SECRET: ${OUTLOOK_CLIENT_SECRET}
      OUTLOOK_REDIRECT_URI: ${OUTLOOK_REDIRECT_URI:-http://localhost:3001/api/email/auth/outlook/callback}

      # Web Scraping
      WEB_SCRAPING_REDIS_URL: redis://redis:6379
      SCRAPER_ENABLE_SCREENSHOTS: ${SCRAPER_ENABLE_SCREENSHOTS:-false}

      # RAG Logging
      RAG_LOG_VERBOSE: ${RAG_LOG_VERBOSE:-false}
    ports:
      - "3001:3001"
    volumes:
      - ./backend:/app/backend
      - ./data:/app/data  # For web scraping screenshots
    working_dir: /app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - digitaltwin-network
    command: npm run dev --workspace=backend

  # =============================================================================
  # FRONTEND - React + Vite
  # =============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: digitaltwin-frontend
    environment:
      VITE_API_URL: http://localhost:3001
      VITE_WS_URL: ws://localhost:3001
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    networks:
      - digitaltwin-network
    command: npm run dev

  # =============================================================================
  # NGINX - Reverse Proxy
  # =============================================================================
  nginx:
    image: nginx:alpine
    container_name: digitaltwin-nginx
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - frontend
      - backend
    networks:
      - digitaltwin-network

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  postgres_data:
    driver: local

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  digitaltwin-network:
    driver: bridge
